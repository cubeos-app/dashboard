# =============================================================================
# CubeOS Dashboard Pipeline - Build, Package, Deploy
# =============================================================================
stages:
  - build
  - package
  - deploy

variables:
  GHCR_IMAGE: "ghcr.io/cubeos-app/dashboard"

# -----------------------------------------------------------------------------
# BUILD - Install deps and build static files
# -----------------------------------------------------------------------------
build:
  stage: build
  tags: [docker]
  image: node:20-alpine
  script:
    - npm ci
    - npm run build
    - ls -la dist/
  artifacts:
    paths:
      - dist/
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"

# -----------------------------------------------------------------------------
# PACKAGE - Build multi-arch Docker image and push to ghcr.io
# -----------------------------------------------------------------------------
package:
  stage: package
  tags: [docker]
  image: docker:24
  services:
    - name: docker:24-dind
      command: ["--tls=false"]
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - echo "$GHCR_TOKEN" | docker login ghcr.io -u "$GHCR_USER" --password-stdin
    # Install QEMU for multi-arch
    - docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
    # Create buildx builder using docker-container driver with explicit endpoint
    - docker buildx create --name mybuilder --driver docker-container --driver-opt network=host
    - docker buildx use mybuilder
    - docker buildx inspect --bootstrap
  script:
    - |
      docker buildx build \
        --platform linux/amd64,linux/arm64 \
        --push \
        -t ${GHCR_IMAGE}:${CI_COMMIT_SHORT_SHA} \
        -t ${GHCR_IMAGE}:latest \
        .
    - echo "‚úÖ Pushed multi-arch ${GHCR_IMAGE}:${CI_COMMIT_SHORT_SHA}"
  after_script:
    - docker buildx rm mybuilder || true
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

# -----------------------------------------------------------------------------
# DEPLOY - Pull image on Pi and restart
# -----------------------------------------------------------------------------
deploy:
  stage: deploy
  tags: [arm64, cubeos, deploy]
  before_script:
    - echo "$GHCR_TOKEN" | docker login ghcr.io -u "$GHCR_USER" --password-stdin
  script:
    - echo "üöÄ Deploying CubeOS Dashboard..."
    - docker pull ${GHCR_IMAGE}:${CI_COMMIT_SHORT_SHA}
    - docker tag ${GHCR_IMAGE}:${CI_COMMIT_SHORT_SHA} cubeos-dashboard:latest
    - docker compose -f /cubeos/docker-compose.yml up -d --force-recreate cubeos-dashboard
    - |
      echo "‚è≥ Waiting for Dashboard to be healthy..."
      for i in $(seq 1 30); do
        if curl -sf http://localhost:8080/ > /dev/null 2>&1; then
          echo "‚úÖ Health check passed!"
          exit 0
        fi
        echo "  Attempt $i/30..."
        sleep 2
      done
      echo "‚ùå Health check failed!"
      exit 1
  environment:
    name: production
    url: http://cubeos.cube
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: on_success
