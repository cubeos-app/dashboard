# =============================================================================
# CubeOS Dashboard Pipeline - Build, Package, Deploy
# =============================================================================
#
# DEPLOY STRATEGY (via SSH to Pi):
#   1. Stop watchdog timer (prevents interference during deploy)
#   2. stack rm -> wait for drain
#   3. stack deploy with local-only image (no registry prefix)
#   4. Wait for convergence + HTTP health check
#   5. Restart watchdog timer (always, even on failure — via after_script)
#
# =============================================================================

stages:
  - build
  - package
  - deploy

variables:
  GHCR_IMAGE: "ghcr.io/cubeos-app/dashboard"
  BUILDER_IMAGE: "ghcr.io/cubeos-app/dashboard-builder"
  LOCAL_IMAGE: "cubeos-dashboard"
  SERVICE_NAME: "cubeos-dashboard_cubeos-dashboard"
  STACK_NAME: "cubeos-dashboard"
  COMPOSE_DIR: "/cubeos/coreapps/cubeos-dashboard/appconfig"
  HEALTH_URL: "http://127.0.0.1:6011/"
  CONVERGE_TIMEOUT: "180"
  HEALTH_TIMEOUT: "90"

# -----------------------------------------------------------------------------
# BUILD - Build static files (for MR validation)
# -----------------------------------------------------------------------------
build:
  stage: build
  tags: [multiarch]
  image: node:20-alpine
  script:
    - npm ci
    - npm run build
    - ls -la dist/
  artifacts:
    paths:
      - dist/
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# -----------------------------------------------------------------------------
# PACKAGE - Build multi-arch Docker image
# -----------------------------------------------------------------------------
package:
  stage: package
  tags: [multiarch]
  image: docker:24
  before_script:
    - echo "$GHCR_TOKEN" | docker login ghcr.io -u "$GHCR_USER" --password-stdin
    - docker buildx create --name mybuilder --driver docker-container --use 2>/dev/null || docker buildx use mybuilder
    - docker buildx inspect --bootstrap
  script:
    - echo "Building dashboard image..."
    - >-
      docker buildx build
      --platform linux/amd64,linux/arm64
      --build-arg BUILDER_IMAGE=${BUILDER_IMAGE}:latest
      --push
      -t ${GHCR_IMAGE}:${CI_COMMIT_SHORT_SHA}
      -t ${GHCR_IMAGE}:latest
      .
    - echo "Pushed ${GHCR_IMAGE}:${CI_COMMIT_SHORT_SHA}"
  after_script:
    - docker buildx rm mybuilder 2>/dev/null || true
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

# -----------------------------------------------------------------------------
# DEPLOY — via SSH to Pi
# -----------------------------------------------------------------------------
deploy:
  stage: deploy
  tags: [multiarch]
  image: alpine:latest
  needs:
    - package
  before_script:
    - apk add --no-cache openssh-client curl
    - eval $(ssh-agent -s)
    - echo "$CI_DEPLOY_SSH_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh && chmod 700 ~/.ssh
    - ssh-keyscan -H ${PI_DEPLOY_ADDR} >> ~/.ssh/known_hosts 2>/dev/null
  script:
    - scp scripts/ci-deploy.sh ${PI_DEPLOY_HOST}:/tmp/ci-deploy-dashboard.sh
    - |
      ssh -o ServerAliveInterval=15 ${PI_DEPLOY_HOST} \
        "GHCR_TOKEN='${GHCR_TOKEN}' \
         GHCR_USER='${GHCR_USER}' \
         GHCR_IMAGE='${GHCR_IMAGE}' \
         CI_COMMIT_SHORT_SHA='${CI_COMMIT_SHORT_SHA}' \
         bash /tmp/ci-deploy-dashboard.sh"
    - ssh ${PI_DEPLOY_HOST} "rm -f /tmp/ci-deploy-dashboard.sh"
  # ALWAYS restart watchdog, even on failure — separate SSH call
  after_script:
    - |
      # Re-setup SSH agent for after_script (GitLab runs this in a new shell)
      apk add --no-cache openssh-client 2>/dev/null || true
      eval $(ssh-agent -s)
      echo "$CI_DEPLOY_SSH_KEY" | tr -d '\r' | ssh-add -
      mkdir -p ~/.ssh && chmod 700 ~/.ssh
      ssh-keyscan -H ${PI_DEPLOY_ADDR} >> ~/.ssh/known_hosts 2>/dev/null
      echo "=== Restarting watchdog ==="
      ssh -o ConnectTimeout=10 ${PI_DEPLOY_HOST} \
        "sudo systemctl start cubeos-watchdog.timer 2>/dev/null || true; echo '  Watchdog timer restarted'" \
        || echo "  WARNING: Could not restart watchdog via SSH"
      kill $SSH_AGENT_PID 2>/dev/null || true
  environment:
    name: production
    url: http://cubeos.cube
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: on_success
